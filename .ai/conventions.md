# Соглашения по коду и архитектуре

## Структура проекта

Проект следует стандартной для Go структуре, разделяя код по его назначению:

*   `/cmd/server`: Точка входа приложения (`main.go`).
*   `/internal`: Внутренняя логика приложения, недоступная для импорта извне.
    *   `/auth`: Middleware для аутентификации и проверки ролей.
    *   `/config`: Загрузка конфигурации.
    *   `/database`: Настройка подключения к БД и запуск миграций.
    *   `/handler`: Обработчики HTTP-запросов (контроллеры).
    *   `/models`: Структуры данных GORM (модели БД).
*   `/pkg`: Пакеты, которые можно безопасно импортировать (например, хелпер для JWT).
*   `/docs`: Сгенерированная Swagger-документация.
*   `/.ai`: Директория для хранения мета-информации о проекте.

## API

*   **Версионирование:** Все эндпоинты находятся под префиксом `/api/v1`.
*   **Аутентификация:** Используются Bearer-токены (JWT). Защищенные маршруты требуют заголовок `Authorization: Bearer <token>`.
*   **Авторизация (роли):** Введена система ролей (`user`, `admin`). Доступ к административным эндпоинтам (`/admin/*`) ограничен middleware, проверяющим роль пользователя (`auth.AdminMiddleware`).
*   **DTO (Data Transfer Objects):** В пакете `handler` определены структуры для входящих запросов (`...Input`) и исходящих ответов (`...Response`). Это позволяет отделить API-представление от модели базы данных и обеспечивает чистоту логики.
    *   **`PublicUserResponse`**: Структура для публичных профилей пользователей, не содержит приватных данных (например, email). Теперь включает `CurrentLobbyID`.
    *   **`PrivateUserResponse`**: Структура для собственного профиля пользователя (`/users/me`), содержит приватные данные. Теперь включает `CurrentLobbyID`.
    *   **`TagResponse`**: Для возврата информации о тегах.
    *   **`GameInput`**: Для создания/обновления игр.
    *   **`GameResponse`**: Для возврата информации об играх, включая связанные теги.
    *   **`LobbyInput`**: Для создания/обновления лобби.
    *   **`LobbyResponse`**: Для возврата информации о лобби, включая хоста, игру и участников.
    *   **`PaginatedUserResponse`, `PaginationMeta`**: Для стандартизированных ответов с пагинацией.

## База данных

*   **Миграции:** На данный момент используется `gorm.AutoMigrate()` для простоты разработки. Это автоматически создает и обновляет таблицы на основе GORM-моделей.
    *   **Примечание:** Для продакшн-среды следует перейти на полноценный инструмент миграций, например, `golang-migrate/migrate`.
*   **Логирование GORM:** Настроен специальный логгер GORM, который игнорирует сообщения "record not found", что делает логи более чистыми.
*   **Модель отношений (Friendship):**
    *   Модель асимметрична. Связь `A -> B` со статусом `pending` означает, что A подписан на B (отправил заявку).
    *   Связь `A -> B` со статусом `accepted` означает, что A и B — друзья (по инициативе A).
    *   Взаимная дружба — это наличие двух `accepted` записей: `A -> B` и `B -> A`.
    *   **`friends_count`:** Теперь подсчитывает все `accepted` отношения, где пользователь является `from_user_id` ИЛИ `to_user_id`, что обеспечивает симметричный подсчет.
    *   Удаление "друга" B пользователем A означает удаление записи `A -> B`. При этом запись `B -> A` может остаться, что интерпретируется как "B все еще подписан на A".

*   **Модель лобби:**
    *   Определяет структуру игрового лобби (`models.Lobby`).
    *   Каждый пользователь может находиться только в одном лобби, что отражено полем `CurrentLobbyID` в `models.User`.
    *   В лобби есть хост (`HostID`), игра (`GameID`) и список участников (`Members`).
